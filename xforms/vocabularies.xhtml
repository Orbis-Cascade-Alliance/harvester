<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:xs="http://www.w3.org/2001/XMLSchema"
	xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xi="http://www.w3.org/2001/XInclude"
	xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:dcterms="http://purl.org/dc/terms/" xmlns:oai="http://www.openarchives.org/OAI/2.0/" xmlns:oai_dc="http://www.openarchives.org/OAI/2.0/oai_dc/"
	xmlns:dcmitype="http://purl.org/dc/dcmitype/" xmlns:res="http://www.w3.org/2005/sparql-results#" xmlns:edm="http://www.europeana.eu/schemas/edm/"
	xmlns:skos="http://www.w3.org/2004/02/skos/core#" xmlns:harvester="https://github.com/Orbis-Cascade-Alliance/harvester">
	<head>
		<title>OAI-PMH Harvester: Ingest Vocabularies</title>
		<link rel="stylesheet" href="/fr/style/bootstrap/css/bootstrap.css" type="text/css" />
		<link rel="stylesheet" href="/fr/style/form-runner-bootstrap-override.css" type="text/css" />
		<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
		<script type="text/javascript" src="https://netdna.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<link rel="shortcut icon" href="/ops/images/orbeon-icon-16.ico" />
		<link rel="icon" href="/ops/images/orbeon-icon-16.png" type="image/png" />
		<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Gentium+Book+Basic:400,700" />
		<link rel="stylesheet" type="text/css" href="/apps/harvester/xforms/css/style.css" />

		<xforms:model>
			<xforms:instance id="control-instance" xxforms:exclude-result-prefixes="#all">
				<controls xmlns="">
					<status></status>
					<local-message></local-message>
					<uri></uri>
					<definition></definition>
					<search-results></search-results>
					<repository></repository>
					<repository_uri></repository_uri>
					<sparql-service></sparql-service>
					<heading>local.personalNames+all</heading>
				</controls>
			</xforms:instance>

			<xforms:instance id="config" xxforms:exclude-result-prefixes="#all">
				<xi:include href="../config.xml"/>
			</xforms:instance>

			<!-- SPARQL templates -->
			<xforms:instance id="sparqlQuery-templates">
				<queries xmlns="">
					<query id="get-literals"><![CDATA[
						
]]></query>
				</queries>
			</xforms:instance>

			<xforms:instance id="sparqlUpdate-templates">
				<queries xmlns="">
					<query id="replace-literal-with-uri"><![CDATA[PREFIX rdf:	<http://www.w3.org/1999/02/22-rdf-syntax-ns#>
DELETE {?s ?p ?o} WHERE { 
?s ?p ?o . FILTER (?s = <URI>)
}]]></query>
					<query id="insert-vocab"><![CDATA[PREFIX rdf:	<http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX dcterms:	<http://purl.org/dc/terms/>
PREFIX dcam:	<http://purl.org/dc/dcam/>
PREFIX edm:	<http://www.europeana.eu/schemas/edm/>
PREFIX xsd:	<http://www.w3.org/2001/XMLSchema#>
PREFIX rdfs:	<http://www.w3.org/2000/01/rdf-schema#>
PREFIX skos:	<http://www.w3.org/2004/02/skos/core#>
INSERT DATA
{
  <URI> rdf:type TYPE ; 
  		rdfs:label "LABEL" ;
  		dcterms:source "REPO" ;
  		skos:exactMatch <MATCH> ;
  		dcam:memberOf <VOCAB>
}]]></query>
				</queries>
			</xforms:instance>

			<xforms:instance id="sparqlQuery">
				<query xmlns=""></query>
			</xforms:instance>

			<xforms:instance id="sparqlResponse" xxforms:exclude-result-prefixes="#all">
				<sparql xmlns="http://www.w3.org/2005/sparql-results#"/>
			</xforms:instance>
			
			<!-- lists of existing vocabularies -->
			<xforms:instance id="type-vocabs" xxforms:exclude-result-prefixes="#all">
				<sparql xmlns="http://www.w3.org/2005/sparql-results#"/>
			</xforms:instance>
			
			<xforms:instance id="place-vocabs" xxforms:exclude-result-prefixes="#all">
				<sparql xmlns="http://www.w3.org/2005/sparql-results#"/>
			</xforms:instance>
			
			<xforms:instance id="agent-vocabs" xxforms:exclude-result-prefixes="#all">
				<sparql xmlns="http://www.w3.org/2005/sparql-results#"/>
			</xforms:instance>
			
			<!-- RDF templates -->
			<xforms:instance id="concept-template" xxforms:exclude-result-prefixes="#all">
				<skos:Concept rdf:about="">
					<skos:prefLabel xml:lang="en"/>
				</skos:Concept>
			</xforms:instance>
			
			<xforms:instance id="agent-template" xxforms:exclude-result-prefixes="#all">
				<edm:Agent rdf:about="">
					<skos:prefLabel xml:lang="en"/>
				</edm:Agent>
			</xforms:instance>

			<!-- ************************* SUBMISSIONS ************************** -->
			<xforms:bind nodeset="instance('control-instance')">
				<xforms:bind nodeset="repository_uri"
					calculate="if (instance('config')/codes/repository[@marc=instance('control-instance')/repository]/@harvester-only = true()) then concat(instance('config')/url, 'agency/', instance('control-instance')/repository) else concat(instance('config')/production_server, 'contact#', instance('control-instance')/repository)"
				/>
			</xforms:bind>

			<!-- ************************* SUBMISSIONS ************************** -->
			<!-- SPARQL queries -->
			<xforms:submission id="submit-sparqlQuery" action="{instance('config')/sparql/query}?query={encode-for-uri(instance('sparqlQuery'))}&amp;output=xml"
				ref="instance('sparqlResponse')" replace="instance" method="get">
				<xforms:message ev:event="xforms-submit-error" level="modal">SPARQL query failed.</xforms:message>
			</xforms:submission>

			<xforms:submission id="update-graph" action="{instance('config')/sparql/update}" ref="instance('sparqlQuery')" serialization="text/plain"
				replace="none" method="post" mediatype="application/sparql-update">
				<xforms:action ev:event="xforms-submit-error">
					<xforms:message level="modal">SPARQL update failed.</xforms:message>
				</xforms:action>
			</xforms:submission>

			<!-- ************************* XFORMS-MODEL-CONSTRUCT-DONE ************************** -->
			<!-- get the list of repositories from the SPARQL endpoint on xforms-model-construct-done -->
			<xforms:action ev:event="xforms-model-construct-done">
				<xforms:action if="not(xxforms:is-user-in-role('harvester-admin'))">
					<xforms:insert context="instance('control-instance')" nodeset="status" position="after"
						origin="xxforms:call-xpl('oxf:/apps/harvester/xpl/get-authentication.xpl', 'dump', instance('dump'), 'data')"/>
					<xforms:setvalue ref="instance('control-instance')/repository" value="instance('control-instance')/request-security/role"/>
				</xforms:action>
			</xforms:action>
		</xforms:model>
	</head>
	<body style="font-family:'Gentium Book Basic'">
		<div class="container">
			<xforms:group ref=".[string-length(instance('control-instance')/status) &gt; 0]">
				<div class="row">
					<div class="col-md-12">
						<div class="bg-info alert">
							<p>
								<span class="glyphicon glyphicon-info-sign"></span>
								<strong>Status:</strong>
								<xforms:output ref="instance('control-instance')/status"/>
							</p>
						</div>
					</div>
				</div>
			</xforms:group>
			<div class="row">
				<div class="col-md-6 banner">
					<img src="/apps/harvester/ui/images/header.jpg" style="max-height:100%;" alt="header-image" />
				</div>
				<div class="col-md-6 banner">
					<h1>HARVESTER</h1>
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<hr />
					<xforms:group ref=".[xxforms:is-user-in-role('harvester-admin')]">
						<div class="subsection">
							<h4>Repository Code</h4>
							<div>
								<xforms:select1 ref="instance('control-instance')/repository">
									<xforms:alert>Required</xforms:alert>
									<xforms:item>
										<xforms:label>Select...</xforms:label>
										<xforms:value/>
									</xforms:item>
									<xforms:itemset
										nodeset="xxforms:sort(distinct-values(instance('config')//repository), ., 'text', 'ascending')">
										<xforms:label ref="."/>
										<xforms:value ref="."/>
									</xforms:itemset>
								</xforms:select1>
							</div>
						</div>
					</xforms:group>
					
					<div class="subsection">
						<h4>Vocabularies</h4>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>
